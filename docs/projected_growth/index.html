<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWEA Projected Growth Comparison</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        .subtitle {
            color: #888;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
        .control-group select {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #fff;
            min-width: 160px;
            cursor: pointer;
        }
        .control-group select:hover {
            border-color: #4472C4;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #16213e;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #16213e;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 11px;
            color: #888;
        }
        .table-container {
            overflow-x: auto;
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
        }
        table {
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 2px 3px;
            text-align: center;
            border: 1px solid #333;
        }
        th {
            background: #2d3a5a;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .rit-col {
            background: #2d3a5a;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 5;
            padding: 2px 4px;
        }
        .corner {
            position: sticky;
            left: 0;
            top: 0;
            z-index: 15;
            background: #2d3a5a;
            white-space: nowrap;
        }
        .na {
            background: #1a1a2e;
            color: #444;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }
        .view-description {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #16213e;
            border-radius: 8px;
            border-left: 3px solid #4472C4;
        }
    </style>
</head>
<body>
    <h1>NWEA Projected Growth Comparison</h1>
    <p class="subtitle">Compare 2020 vs 2025 norms projected growth by grade and starting RIT</p>

    <div class="controls">
        <div class="control-group">
            <label>Subject</label>
            <select id="subject">
                <option value="Math">Math</option>
                <option value="Reading">Reading</option>
                <option value="Language">Language</option>
                <option value="Science">Science</option>
            </select>
        </div>
        <div class="control-group">
            <label>Growth Period</label>
            <select id="period">
                <option value="fall_to_winter">Fall to Winter</option>
                <option value="fall_to_fall">Fall to Fall</option>
                <option value="winter_to_winter">Winter to Winter</option>
                <option value="fall_to_spring">Fall to Spring</option>
                <option value="winter_to_spring">Winter to Spring</option>
                <option value="spring_to_spring">Spring to Spring</option>
            </select>
        </div>
        <div class="control-group">
            <label>View</label>
            <select id="view">
                <option value="2020">2020 Norms</option>
                <option value="2025">2025 Norms</option>
                <option value="diff">Diff (2025 - 2020)</option>
                <option value="ratio">Ratio (2025 / 2020)</option>
            </select>
        </div>
    </div>

    <div class="view-description" id="viewDesc"></div>

    <div class="legend" id="legend"></div>

    <div class="stats" id="stats"></div>

    <div class="table-container">
        <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        let growthData = null;

        const viewDescriptions = {
            '2020': 'Showing projected growth from 2020 norms. Higher values (green) indicate more expected growth.',
            '2025': 'Showing projected growth from 2025 norms. Higher values (green) indicate more expected growth.',
            'diff': 'Showing 2025 minus 2020. Positive (red) = HARDER in 2025. Negative (green) = EASIER in 2025.',
            'ratio': 'Showing 2025 divided by 2020. Above 1.0 (red) = HARDER in 2025. Below 1.0 (green) = EASIER in 2025.'
        };

        const grades = ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];

        async function loadData() {
            const response = await fetch('../projected_growth_data.json');
            growthData = await response.json();
            updateTable();
        }

        function getColor2020_2025(value, min, max) {
            // Green to yellow gradient for absolute values
            if (value === null) return '#1a1a2e';
            const range = max - min || 1;
            const ratio = (value - min) / range;

            // High values = dark green, low values = yellow
            if (ratio > 0.75) return '#006400';  // Dark green
            if (ratio > 0.5) return '#228B22';   // Forest green
            if (ratio > 0.25) return '#90EE90';  // Light green
            return '#FFFF99';                     // Yellow
        }

        function getColorDiff(value) {
            // Positive = harder = red, Negative = easier = green
            if (value === null) return '#1a1a2e';
            if (value > 2) return '#8B0000';      // Dark red (much harder)
            if (value > 0.5) return '#CD5C5C';    // Indian red (harder)
            if (value > 0) return '#FFCCCB';      // Light red (slightly harder)
            if (value === 0) return '#888888';    // Gray (same)
            if (value > -0.5) return '#90EE90';   // Light green (slightly easier)
            if (value > -2) return '#228B22';     // Forest green (easier)
            return '#006400';                      // Dark green (much easier)
        }

        function getColorRatio(value) {
            // Above 1.0 = harder = red, Below 1.0 = easier = green
            if (value === null) return '#1a1a2e';
            if (value > 1.2) return '#8B0000';    // Dark red (much harder)
            if (value > 1.05) return '#CD5C5C';   // Indian red (harder)
            if (value > 1.0) return '#FFCCCB';    // Light red (slightly harder)
            if (value === 1.0) return '#888888';  // Gray (same)
            if (value > 0.95) return '#90EE90';   // Light green (slightly easier)
            if (value > 0.8) return '#228B22';    // Forest green (easier)
            return '#006400';                      // Dark green (much easier)
        }

        function updateLegend(view) {
            const legend = document.getElementById('legend');

            if (view === '2020' || view === '2025') {
                legend.innerHTML = `
                    <div class="legend-item"><div class="legend-box" style="background:#006400"></div>High growth (8+)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#228B22"></div>Medium-high (5-7)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#90EE90"></div>Medium (3-4)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#FFFF99"></div>Low (1-2)</div>
                `;
            } else if (view === 'diff') {
                legend.innerHTML = `
                    <div class="legend-item"><div class="legend-box" style="background:#8B0000"></div>Much harder (+2+)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#FFCCCB"></div>Slightly harder (0 to +2)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#888"></div>Same (0)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#90EE90"></div>Slightly easier (0 to -2)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#006400"></div>Much easier (-2+)</div>
                `;
            } else if (view === 'ratio') {
                legend.innerHTML = `
                    <div class="legend-item"><div class="legend-box" style="background:#8B0000"></div>Much harder (> 1.2)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#FFCCCB"></div>Slightly harder (1.0-1.2)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#888"></div>Same (1.0)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#90EE90"></div>Slightly easier (0.8-1.0)</div>
                    <div class="legend-item"><div class="legend-box" style="background:#006400"></div>Much easier (< 0.8)</div>
                `;
            }
        }

        function updateTable() {
            if (!growthData) return;

            const subject = document.getElementById('subject').value;
            const period = document.getElementById('period').value;
            const view = document.getElementById('view').value;

            document.getElementById('viewDesc').textContent = viewDescriptions[view];
            updateLegend(view);

            const data2020 = growthData['2020'][subject][period] || {};
            const data2025 = growthData['2025'][subject][period] || {};

            // Get all RIT scores
            const allRits = new Set();
            Object.keys(data2020).forEach(k => allRits.add(parseInt(k.split('_')[1])));
            Object.keys(data2025).forEach(k => allRits.add(parseInt(k.split('_')[1])));
            const rits = Array.from(allRits).sort((a, b) => a - b);

            // Get all grades with data
            const allGrades = new Set();
            Object.keys(data2020).forEach(k => allGrades.add(k.split('_')[0]));
            Object.keys(data2025).forEach(k => allGrades.add(k.split('_')[0]));
            const activeGrades = grades.filter(g => allGrades.has(g));

            if (rits.length === 0 || activeGrades.length === 0) {
                document.getElementById('tableHead').innerHTML = '';
                document.getElementById('tableBody').innerHTML = '<tr><td class="no-data" colspan="15">No data available for this combination</td></tr>';
                document.getElementById('stats').innerHTML = '';
                return;
            }

            // Build table
            let values = [];
            let tableData = [];

            for (const rit of rits) {
                let row = { rit, cells: [] };
                for (const grade of activeGrades) {
                    const key = `${grade}_${rit}`;
                    const v2020 = data2020[key];
                    const v2025 = data2025[key];

                    let value = null;
                    let display = 'â€”';

                    if (view === '2020') {
                        if (v2020 !== undefined) {
                            value = v2020;
                            display = v2020.toFixed(1);
                        }
                    } else if (view === '2025') {
                        if (v2025 !== undefined) {
                            value = v2025;
                            display = v2025.toFixed(1);
                        }
                    } else if (view === 'diff') {
                        if (v2020 !== undefined && v2025 !== undefined) {
                            value = v2025 - v2020;
                            display = (value >= 0 ? '+' : '') + value.toFixed(1);
                        }
                    } else if (view === 'ratio') {
                        if (v2020 !== undefined && v2025 !== undefined && v2020 !== 0) {
                            value = v2025 / v2020;
                            display = value.toFixed(2);
                        }
                    }

                    if (value !== null) values.push(value);
                    row.cells.push({ value, display });
                }
                tableData.push(row);
            }

            // Calculate stats
            const min = Math.min(...values);
            const max = Math.max(...values);
            const avg = values.reduce((a, b) => a + b, 0) / values.length;

            // Update stats
            document.getElementById('stats').innerHTML = `
                <div class="stat-box"><div class="stat-value">${values.length}</div><div class="stat-label">Cells</div></div>
                <div class="stat-box"><div class="stat-value">${min.toFixed(1)}</div><div class="stat-label">Min</div></div>
                <div class="stat-box"><div class="stat-value">${max.toFixed(1)}</div><div class="stat-label">Max</div></div>
                <div class="stat-box"><div class="stat-value">${avg.toFixed(1)}</div><div class="stat-label">Avg</div></div>
            `;

            // Render table header
            document.getElementById('tableHead').innerHTML = `
                <tr>
                    <th class="corner">RIT \\ Grade</th>
                    ${activeGrades.map(g => `<th>G${g}</th>`).join('')}
                </tr>
            `;

            // Render table body
            let bodyHtml = '';
            for (const row of tableData) {
                bodyHtml += `<tr><td class="rit-col">${row.rit}</td>`;
                for (const cell of row.cells) {
                    let color;
                    if (view === '2020' || view === '2025') {
                        color = getColor2020_2025(cell.value, min, max);
                    } else if (view === 'diff') {
                        color = getColorDiff(cell.value);
                    } else {
                        color = getColorRatio(cell.value);
                    }

                    const textColor = cell.value === null ? '#444' :
                        (color === '#FFFF99' || color === '#90EE90' || color === '#FFCCCB' ? '#000' : '#fff');

                    bodyHtml += `<td style="background:${color};color:${textColor}">${cell.display}</td>`;
                }
                bodyHtml += '</tr>';
            }
            document.getElementById('tableBody').innerHTML = bodyHtml;
        }

        // Event listeners
        document.getElementById('subject').addEventListener('change', updateTable);
        document.getElementById('period').addEventListener('change', updateTable);
        document.getElementById('view').addEventListener('change', updateTable);

        // Load data on page load
        loadData();
    </script>
</body>
</html>
